<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HMS - Lab Requests</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Outfit:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">

    <!-- Stylesheets -->
    <link rel="stylesheet" href="../assets/css/reset.css">
    <link rel="stylesheet" href="../assets/css/variables.css">
    <link rel="stylesheet" href="../assets/css/typography.css">
    <link rel="stylesheet" href="../assets/css/components.css">
    <link rel="stylesheet" href="../assets/css/utilities.css">
    <link rel="stylesheet" href="../assets/css/animations.css">
    <link rel="stylesheet" href="../assets/css/responsive.css">
    <link rel="stylesheet" href="../assets/css/icons.css">

    <style>
        /* Common styles */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: var(--sidebar-width);
            background: white;
            border-right: 1px solid var(--gray-200);
            display: flex;
            flex-direction: column;
            z-index: 100;
        }

        .sidebar-header {
            padding: var(--space-6);
            border-bottom: 1px solid var(--gray-200);
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .sidebar-logo-icon {
            width: 40px;
            height: 40px;
            background: var(--gradient-primary);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: var(--text-xl);
        }

        .sidebar-logo-text {
            font-size: var(--text-lg);
            font-weight: var(--font-bold);
            color: var(--gray-900);
        }

        .sidebar-nav {
            flex: 1;
            padding: var(--space-4);
            overflow-y: auto;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius-md);
            color: var(--gray-700);
            font-weight: var(--font-medium);
            transition: all var(--transition-fast);
            cursor: pointer;
            margin-bottom: var(--space-1);
        }

        .nav-item:hover {
            background: var(--gray-50);
            color: var(--primary-500);
        }

        .nav-item.active {
            background: var(--gradient-primary);
            color: white;
        }

        .nav-icon {
            font-size: var(--text-xl);
            width: 24px;
            text-align: center;
        }

        .sidebar-footer {
            padding: var(--space-4);
            border-top: 1px solid var(--gray-200);
        }

        .header {
            position: fixed;
            top: 0;
            left: var(--sidebar-width);
            right: 0;
            height: var(--header-height);
            background: white;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--space-6);
            z-index: 90;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: var(--font-semibold);
            font-size: var(--text-sm);
        }

        .main-content {
            margin-left: var(--sidebar-width);
            padding-top: var(--header-height);
            min-height: 100vh;
            background: var(--gray-50);
        }

        .content-area {
            padding: var(--space-6);
        }

        /* Lab specific */
        .status-tabs {
            display: flex;
            gap: var(--space-2);
            margin-bottom: var(--space-6);
            flex-wrap: wrap;
        }

        .status-tab {
            padding: var(--space-3) var(--space-6);
            border-radius: var(--radius-full);
            background: white;
            border: 2px solid var(--gray-200);
            font-weight: var(--font-medium);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .status-tab:hover {
            border-color: var(--primary-500);
            color: var(--primary-500);
        }

        .status-tab.active {
            background: var(--gradient-primary);
            color: white;
            border-color: transparent;
        }

        .request-list {
            display: grid;
            gap: var(--space-4);
        }

        .request-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-fast);
        }

        .request-card:hover {
            box-shadow: var(--shadow-md);
        }

        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: var(--space-4);
            padding-bottom: var(--space-4);
            border-top: 1px solid var(--gray-200);
        }

        .request-info {
            flex: 1;
        }

        .request-number {
            font-size: var(--text-lg);
            font-weight: var(--font-semibold);
            color: var(--gray-900);
            margin-bottom: var(--space-1);
        }

        .request-meta {
            display: flex;
            gap: var(--space-4);
            font-size: var(--text-sm);
            color: var(--gray-500);
            flex-wrap: wrap;
        }

        .tests-list {
            margin-bottom: var(--space-4);
        }

        .test-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-3);
            background: var(--gray-50);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-2);
        }

        .test-name {
            font-weight: var(--font-medium);
            color: var(--gray-900);
            margin-bottom: var(--space-1);
        }

        .test-category {
            font-size: var(--text-sm);
            color: var(--gray-600);
        }

        .test-price {
            font-weight: var(--font-semibold);
            color: var(--primary-500);
        }

        .request-actions {
            display: flex;
            gap: var(--space-2);
            justify-content: flex-end;
        }

        @media (max-width: 1023px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .header {
                left: 0;
            }

            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>

<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <div class="logo-icon"></div>
                <div class="sidebar-logo-text">HMS</div>
            </div>
        </div>

        <nav class="sidebar-nav">
            <a href="../dashboard.html" class="nav-item">
                <span class="nav-icon">📊</span>
                <span>Dashboard</span>
            </a>
            <a href="../patients/list.html" class="nav-item">
                <span class="nav-icon">👥</span>
                <span>Patients</span>
            </a>
            <a href="../patients/queue.html" class="nav-item">
                <span class="nav-icon">⏱️</span>
                <span>Queue</span>
            </a>
            <a href="../pharmacy/inventory.html" class="nav-item">
                <span class="nav-icon">💊</span>
                <span>Pharmacy</span>
            </a>
            <a href="requests.html" class="nav-item active">
                <span class="nav-icon">🔬</span>
                <span>Laboratory</span>
            </a>
            <a href="../billing/invoices.html" class="nav-item">
                <span class="nav-icon">💰</span>
                <span>Billing</span>
            </a>
            <a href="../reports/analytics.html" class="nav-item">
                <span class="nav-icon">📈</span>
                <span>Reports</span>
            </a>
        </nav>

        <div class="sidebar-footer">
            <button class="btn btn-ghost w-full" onclick="Auth.logout()">
                <span>🚪</span>
                <span>Logout</span>
            </button>
        </div>
    </aside>

    <!-- Header -->
    <header class="header">
        <div class="header-search">
            <button class="mobile-menu-toggle">
                <span>☰</span>
            </button>
        </div>
        <div class="header-actions">
            <div class="user-avatar" id="userAvatar"></div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="content-area">
            <!-- Page Header -->
            <div class="page-header">
                <div>
                    <h1 class="page-title">Laboratory Requests</h1>
                    <div class="breadcrumb">
                        <a href="../dashboard.html">Dashboard</a>
                        <span class="breadcrumb-separator">›</span>
                        <span class="breadcrumb-current">Laboratory</span>
                    </div>
                </div>
            </div>

            <!-- Status Tabs -->
            <div class="status-tabs">
                <button class="status-tab active" data-status="all">All Requests</button>
                <button class="status-tab" data-status="Pending">Pending</button>
                <button class="status-tab" data-status="SampleCollected">Sample Collected</button>
                <button class="status-tab" data-status="InProgress">In Progress</button>
                <button class="status-tab" data-status="Completed">Completed</button>
            </div>

            <!-- Request List -->
            <div class="request-list" id="requestList">
                <!-- Requests will be loaded here -->
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="empty-state" style="display: none;">
                <div class="empty-state-icon">🔬</div>
                <div class="empty-state-title">No lab requests found</div>
                <div class="empty-state-message">Lab requests will appear here when doctors order tests</div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <!-- Scripts -->
    <script src="../assets/js/utils/icons.js"></script>
    <script src="../assets/js/utils/icon-init.js"></script>
    <script src="../assets/js/core/storage.js"></script>
    <script src="../assets/js/utils/helpers.js"></script>
    <script src="../assets/js/data/generator.js"></script>
    <script src="../assets/js/modules/auth.js"></script>
    <script src="../assets/js/components/ui.js"></script>

    <script>
        // Require authentication
        Auth.requireAuth();

        // Get current user
        const currentUser = Auth.getCurrentUser();
        document.getElementById('userAvatar').textContent = Auth.getUserInitials();

        // State
        let currentStatus = 'all';

        // Load requests
        function loadRequests() {
            let requests = storage.getAll('lab_requests');

            // Filter by status
            if (currentStatus !== 'all') {
                requests = requests.filter(r => r.status === currentStatus);
            }

            // Sort by date (newest first)
            requests.sort((a, b) => new Date(b.requestDate) - new Date(a.requestDate));

            renderRequests(requests);
        }

        // Render requests
        function renderRequests(requests) {
            const requestList = document.getElementById('requestList');
            const emptyState = document.getElementById('emptyState');

            if (requests.length === 0) {
                requestList.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            requestList.style.display = 'grid';
            emptyState.style.display = 'none';

            const html = requests.map(request => {
                const patient = storage.getById('patients', request.patientId);
                const doctor = storage.getById('users', request.requestedBy);
                const labTests = storage.getAll('lab_tests');

                const patientName = patient ? `${patient.firstName} ${patient.lastName}` : 'Unknown Patient';
                const doctorName = doctor ? doctor.name : 'Unknown Doctor';

                // Get test details
                const tests = request.tests.map(testId => {
                    const test = labTests.find(t => t.id === testId);
                    return test || { name: 'Unknown Test', category: 'N/A', price: 0 };
                });

                const totalPrice = tests.reduce((sum, test) => sum + test.price, 0);

                return `
          <div class="request-card">
            <div class="request-header">
              <div class="request-info">
                <div class="request-number">${request.id}</div>
                <div class="request-meta">
                  <span>👤 ${patientName}</span>
                  <span>👨‍⚕️ Dr. ${doctorName}</span>
                  <span>📅 ${DateUtils.formatDate(request.requestDate, 'datetime')}</span>
                </div>
              </div>
              <div>
                <span class="badge badge-${request.status === 'Completed' ? 'success' :
                        request.status === 'InProgress' ? 'warning' :
                            'info'
                    }">
                  ${request.status}
                </span>
              </div>
            </div>

            <div class="tests-list">
              ${tests.map(test => `
                <div class="test-item">
                  <div>
                    <div class="test-name">${test.name}</div>
                    <div class="test-category">${test.category}</div>
                  </div>
                  <div class="test-price">${NumberUtils.formatCurrency(test.price)}</div>
                </div>
              `).join('')}
            </div>

            <div class="request-actions">
              <div style="flex: 1; text-align: left;">
                <strong>Total: ${NumberUtils.formatCurrency(totalPrice)}</strong>
              </div>
              ${request.status === 'Pending' ? `
                <button class="btn btn-primary btn-sm" onclick="collectSample('${request.id}')">
                  Collect Sample
                </button>
              ` : ''}
              ${request.status === 'SampleCollected' ? `
                <button class="btn btn-primary btn-sm" onclick="startProcessing('${request.id}')">
                  Start Processing
                </button>
              ` : ''}
              ${request.status === 'InProgress' ? `
                <button class="btn btn-success btn-sm" onclick="completeTest('${request.id}')">
                  Mark Complete
                </button>
              ` : ''}
              ${request.status === 'Completed' ? `
                <span style="color: var(--success); font-size: var(--text-sm);">
                  ✓ Completed on ${DateUtils.formatDate(request.completedDate, 'short')}
                </span>
              ` : ''}
            </div>
          </div>
        `;
            }).join('');

            requestList.innerHTML = html;
        }

        // Status tab switching
        document.querySelectorAll('.status-tab').forEach(tab => {
            tab.addEventListener('click', function () {
                document.querySelectorAll('.status-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                currentStatus = this.dataset.status;
                loadRequests();
            });
        });

        // Collect sample
        function collectSample(requestId) {
            Modal.confirm(
                'Collect Sample',
                'Mark sample as collected for this lab request?',
                () => {
                    storage.update('lab_requests', requestId, {
                        status: 'SampleCollected',
                        sampleCollectedDate: new Date().toISOString(),
                        sampleCollectedBy: currentUser.id
                    });
                    Toast.success('Sample collected successfully');
                    loadRequests();
                }
            );
        }

        // Start processing
        function startProcessing(requestId) {
            Modal.confirm(
                'Start Processing',
                'Begin processing this lab request?',
                () => {
                    storage.update('lab_requests', requestId, {
                        status: 'InProgress',
                        processingStartedDate: new Date().toISOString(),
                        processingStartedBy: currentUser.id
                    });
                    Toast.success('Processing started');
                    loadRequests();
                }
            );
        }

        // Complete test
        function completeTest(requestId) {
            const request = storage.getById('lab_requests', requestId);
            const patient = storage.getById('patients', request.patientId);
            const labTests = storage.getAll('lab_tests');

            // Get test details
            const tests = request.tests.map(testId => {
                const test = labTests.find(t => t.id === testId);
                return test || { name: 'Unknown Test', price: 0 };
            });

            const totalPrice = tests.reduce((sum, test) => sum + test.price, 0);

            Modal.confirm(
                'Complete Lab Request',
                `Mark this lab request as completed? This will generate a bill of ${NumberUtils.formatCurrency(totalPrice)}.`,
                () => {
                    Loading.show('Completing lab request...');

                    setTimeout(() => {
                        // Update request status
                        storage.update('lab_requests', requestId, {
                            status: 'Completed',
                            completedDate: new Date().toISOString(),
                            completedBy: currentUser.id
                        });

                        // Create bill
                        const billId = IDGenerator.generateBillNumber();
                        const billItems = tests.map(test => ({
                            description: test.name,
                            quantity: 1,
                            unitPrice: test.price,
                            total: test.price
                        }));

                        storage.add('bills', {
                            id: billId,
                            patientId: request.patientId,
                            billDate: new Date().toISOString(),
                            items: billItems,
                            subtotal: totalPrice,
                            tax: totalPrice * 0.16,
                            total: totalPrice * 1.16,
                            status: 'Pending',
                            createdBy: currentUser.id,
                            createdAt: new Date().toISOString()
                        });

                        Loading.hide();
                        Toast.success(`Lab request completed! Bill ${billId} created.`);
                        loadRequests();
                    }, 1000);
                }
            );
        }

        // Initialize
        loadRequests();
    </script>
</body>

</html>