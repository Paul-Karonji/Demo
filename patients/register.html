<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HMS - Register Patient</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Outfit:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">

    <!-- Stylesheets -->
    <link rel="stylesheet" href="../assets/css/reset.css">
    <link rel="stylesheet" href="../assets/css/variables.css">
    <link rel="stylesheet" href="../assets/css/typography.css">
    <link rel="stylesheet" href="../assets/css/components.css">
    <link rel="stylesheet" href="../assets/css/utilities.css">
    <link rel="stylesheet" href="../assets/css/animations.css">
    <link rel="stylesheet" href="../assets/css/responsive.css">
    <link rel="stylesheet" href="../assets/css/icons.css">

    <style>
        /* Include sidebar and header styles from list.html */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: var(--sidebar-width);
            background: white;
            border-right: 1px solid var(--gray-200);
            display: flex;
            flex-direction: column;
            z-index: 100;
            transition: transform var(--transition-base);
        }

        .sidebar-header {
            padding: var(--space-6);
            border-bottom: 1px solid var(--gray-200);
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .sidebar-logo-icon {
            width: 40px;
            height: 40px;
            background: var(--gradient-primary);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: var(--text-xl);
        }

        .sidebar-logo-text {
            font-size: var(--text-lg);
            font-weight: var(--font-bold);
            color: var(--gray-900);
        }

        .sidebar-nav {
            flex: 1;
            padding: var(--space-4);
            overflow-y: auto;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius-md);
            color: var(--gray-700);
            font-weight: var(--font-medium);
            transition: all var(--transition-fast);
            cursor: pointer;
            margin-bottom: var(--space-1);
        }

        .nav-item:hover {
            background: var(--gray-50);
            color: var(--primary-500);
        }

        .nav-item.active {
            background: var(--gradient-primary);
            color: white;
            box-shadow: var(--shadow-primary);
        }

        .nav-icon {
            font-size: var(--text-xl);
            width: 24px;
            text-align: center;
        }

        .sidebar-footer {
            padding: var(--space-4);
            border-top: 1px solid var(--gray-200);
        }

        .header {
            position: fixed;
            top: 0;
            left: var(--sidebar-width);
            right: 0;
            height: var(--header-height);
            background: white;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--space-6);
            z-index: 90;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }

        .header-user {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .header-user:hover {
            background: var(--gray-50);
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: var(--font-semibold);
            font-size: var(--text-sm);
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-size: var(--text-sm);
            font-weight: var(--font-semibold);
            color: var(--gray-900);
        }

        .user-role {
            font-size: var(--text-xs);
            color: var(--gray-500);
        }

        .main-content {
            margin-left: var(--sidebar-width);
            padding-top: var(--header-height);
            min-height: 100vh;
            background: var(--gray-50);
        }

        .content-area {
            padding: var(--space-6);
        }

        /* Registration Form Specific */
        .registration-form {
            max-width: 900px;
            margin: 0 auto;
        }

        .form-section {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            margin-bottom: var(--space-6);
            box-shadow: var(--shadow-sm);
        }

        .form-section-title {
            font-size: var(--text-xl);
            font-weight: var(--font-semibold);
            color: var(--gray-900);
            margin-bottom: var(--space-4);
            padding-bottom: var(--space-3);
            border-bottom: 2px solid var(--gray-100);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-4);
        }

        .form-grid-full {
            grid-column: 1 / -1;
        }

        .photo-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-4);
        }

        .photo-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: var(--text-4xl);
            font-weight: var(--font-bold);
            overflow: hidden;
        }

        .photo-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .form-actions {
            display: flex;
            gap: var(--space-3);
            justify-content: flex-end;
            padding-top: var(--space-4);
            border-top: 1px solid var(--gray-200);
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }

            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
                box-shadow: var(--shadow-2xl);
            }

            .header {
                left: 0;
            }

            .main-content {
                margin-left: 0;
            }

            .user-info {
                display: none;
            }
        }
    </style>
</head>

<body>
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <div class="logo-icon"></div>
                <div class="sidebar-logo-text">HMS</div>
            </div>
        </div>

        <nav class="sidebar-nav">
            <a href="../dashboard.html" class="nav-item">
                <span class="nav-icon">📊</span>
                <span>Dashboard</span>
            </a>
            <a href="list.html" class="nav-item active">
                <span class="nav-icon">👥</span>
                <span>Patients</span>
            </a>
            <a href="queue.html" class="nav-item">
                <span class="nav-icon">⏱️</span>
                <span>Queue</span>
            </a>
            <a href="../pharmacy/inventory.html" class="nav-item">
                <span class="nav-icon">💊</span>
                <span>Pharmacy</span>
            </a>
            <a href="../laboratory/requests.html" class="nav-item">
                <span class="nav-icon">🔬</span>
                <span>Laboratory</span>
            </a>
            <a href="../billing/invoices.html" class="nav-item">
                <span class="nav-icon">💰</span>
                <span>Billing</span>
            </a>
            <a href="../reports/analytics.html" class="nav-item">
                <span class="nav-icon">📈</span>
                <span>Reports</span>
            </a>
        </nav>

        <div class="sidebar-footer">
            <button class="btn btn-ghost w-full" onclick="Auth.logout()">
                <span>🚪</span>
                <span>Logout</span>
            </button>
        </div>
    </aside>

    <!-- Header -->
    <header class="header">
        <div class="header-actions">
            <div class="header-user" id="userMenu">
                <div class="user-avatar" id="userAvatar"></div>
                <div class="user-info">
                    <div class="user-name" id="userName"></div>
                    <div class="user-role" id="userRole"></div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="content-area">
            <!-- Page Header -->
            <div class="page-header">
                <div>
                    <h1 class="page-title" id="pageTitle">Register New Patient</h1>
                    <div class="breadcrumb">
                        <a href="../dashboard.html">Dashboard</a>
                        <span class="breadcrumb-separator">›</span>
                        <a href="list.html">Patients</a>
                        <span class="breadcrumb-separator">›</span>
                        <span class="breadcrumb-current">Register</span>
                    </div>
                </div>
            </div>

            <!-- Registration Form -->
            <form id="registrationForm" class="registration-form">
                <!-- Personal Information -->
                <div class="form-section">
                    <h2 class="form-section-title">Personal Information</h2>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label required">First Name</label>
                            <input type="text" id="firstName" class="form-input" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label required">Last Name</label>
                            <input type="text" id="lastName" class="form-input" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label required">Date of Birth</label>
                            <input type="date" id="dateOfBirth" class="form-input" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label required">Gender</label>
                            <select id="gender" class="form-select" required>
                                <option value="">Select Gender</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label required">Blood Group</label>
                            <select id="bloodGroup" class="form-select" required>
                                <option value="">Select Blood Group</option>
                                <option value="A+">A+</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B-">B-</option>
                                <option value="AB+">AB+</option>
                                <option value="AB-">AB-</option>
                                <option value="O+">O+</option>
                                <option value="O-">O-</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Photo</label>
                            <div class="photo-upload">
                                <div class="photo-preview" id="photoPreview">
                                    <span id="photoInitials">📷</span>
                                    <img id="photoImage" style="display: none;">
                                </div>
                                <input type="file" id="photoInput" accept="image/*" style="display: none;">
                                <button type="button" class="btn btn-secondary btn-sm"
                                    onclick="document.getElementById('photoInput').click()">
                                    Upload Photo
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contact Information -->
                <div class="form-section">
                    <h2 class="form-section-title">Contact Information</h2>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label required">Phone Number</label>
                            <input type="tel" id="phone" class="form-input" placeholder="+254..." required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Email Address</label>
                            <input type="email" id="email" class="form-input" placeholder="patient@email.com">
                        </div>

                        <div class="form-group form-grid-full">
                            <label class="form-label">Street Address</label>
                            <input type="text" id="street" class="form-input">
                        </div>

                        <div class="form-group">
                            <label class="form-label">City</label>
                            <input type="text" id="city" class="form-input">
                        </div>

                        <div class="form-group">
                            <label class="form-label">County</label>
                            <input type="text" id="county" class="form-input">
                        </div>
                    </div>
                </div>

                <!-- Medical Information -->
                <div class="form-section">
                    <h2 class="form-section-title">Medical Information</h2>

                    <div class="form-grid">
                        <div class="form-group form-grid-full">
                            <label class="form-label">Known Allergies</label>
                            <textarea id="allergies" class="form-textarea" rows="3"
                                placeholder="List any known allergies (e.g., Penicillin, Peanuts)"></textarea>
                        </div>

                        <div class="form-group form-grid-full">
                            <label class="form-label">Chronic Conditions</label>
                            <textarea id="chronicConditions" class="form-textarea" rows="3"
                                placeholder="List any chronic conditions (e.g., Diabetes, Hypertension)"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Emergency Contact -->
                <div class="form-section">
                    <h2 class="form-section-title">Emergency Contact</h2>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label required">Contact Name</label>
                            <input type="text" id="emergencyName" class="form-input" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label required">Relationship</label>
                            <select id="emergencyRelationship" class="form-select" required>
                                <option value="">Select Relationship</option>
                                <option value="Spouse">Spouse</option>
                                <option value="Parent">Parent</option>
                                <option value="Sibling">Sibling</option>
                                <option value="Child">Child</option>
                                <option value="Friend">Friend</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label required">Contact Phone</label>
                            <input type="tel" id="emergencyPhone" class="form-input" placeholder="+254..." required>
                        </div>
                    </div>
                </div>

                <!-- Insurance Information -->
                <div class="form-section">
                    <h2 class="form-section-title">Insurance Information (Optional)</h2>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Insurance Provider</label>
                            <select id="insuranceProvider" class="form-select">
                                <option value="">No Insurance</option>
                                <option value="AAR Insurance">AAR Insurance</option>
                                <option value="Britam">Britam</option>
                                <option value="CIC Insurance">CIC Insurance</option>
                                <option value="NHIF">NHIF</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Policy Number</label>
                            <input type="text" id="policyNumber" class="form-input">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Expiry Date</label>
                            <input type="date" id="insuranceExpiry" class="form-input">
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="form-section">
                    <div class="form-actions">
                        <a href="list.html" class="btn btn-secondary">Cancel</a>
                        <button type="submit" class="btn btn-primary">
                            <span id="submitText">Register Patient</span>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </main>

    <!-- Scripts -->
    <!-- Scripts -->
    <script src="../assets/js/utils/icons.js"></script>
    <script src="../assets/js/utils/icon-init.js"></script>
    <script src="../assets/js/core/storage.js"></script>
    <script src="../assets/js/utils/helpers.js"></script>
    <script src="../assets/js/data/generator.js"></script>
    <script src="../assets/js/modules/auth.js"></script>
    <script src="../assets/js/components/ui.js"></script>

    <script>
        // Require authentication
        Auth.requireAuth();

        // Get current user
        const currentUser = Auth.getCurrentUser();
        document.getElementById('userName').textContent = currentUser.name;
        document.getElementById('userRole').textContent = currentUser.role;
        document.getElementById('userAvatar').textContent = Auth.getUserInitials();

        // Check if editing existing patient
        const urlParams = new URLSearchParams(window.location.search);
        const patientId = urlParams.get('id');
        let isEditMode = false;

        if (patientId) {
            isEditMode = true;
            document.getElementById('pageTitle').textContent = 'Edit Patient';
            document.getElementById('submitText').textContent = 'Update Patient';
            loadPatientData(patientId);
        }

        // Load patient data for editing
        function loadPatientData(id) {
            const patient = storage.getById('patients', id);
            if (!patient) {
                Toast.error('Patient not found');
                window.location.href = 'list.html';
                return;
            }

            document.getElementById('firstName').value = patient.firstName;
            document.getElementById('lastName').value = patient.lastName;
            document.getElementById('dateOfBirth').value = patient.dateOfBirth.split('T')[0];
            document.getElementById('gender').value = patient.gender;
            document.getElementById('bloodGroup').value = patient.bloodGroup;
            document.getElementById('phone').value = patient.phone;
            document.getElementById('email').value = patient.email || '';
            document.getElementById('street').value = patient.address?.street || '';
            document.getElementById('city').value = patient.address?.city || '';
            document.getElementById('county').value = patient.address?.county || '';
            document.getElementById('allergies').value = patient.allergies?.join(', ') || '';
            document.getElementById('chronicConditions').value = patient.chronicConditions?.join(', ') || '';
            document.getElementById('emergencyName').value = patient.emergencyContact?.name || '';
            document.getElementById('emergencyRelationship').value = patient.emergencyContact?.relationship || '';
            document.getElementById('emergencyPhone').value = patient.emergencyContact?.phone || '';
            document.getElementById('insuranceProvider').value = patient.insurance?.provider || '';
            document.getElementById('policyNumber').value = patient.insurance?.policyNumber || '';
            document.getElementById('insuranceExpiry').value = patient.insurance?.expiryDate?.split('T')[0] || '';

            // Update photo preview
            if (patient.firstName && patient.lastName) {
                document.getElementById('photoInitials').textContent =
                    StringUtils.getInitials(patient.firstName, patient.lastName);
            }
        }

        // Photo upload handling
        document.getElementById('photoInput').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (event) {
                    document.getElementById('photoImage').src = event.target.result;
                    document.getElementById('photoImage').style.display = 'block';
                    document.getElementById('photoInitials').style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        });

        // Update photo initials when name changes
        document.getElementById('firstName').addEventListener('input', updatePhotoInitials);
        document.getElementById('lastName').addEventListener('input', updatePhotoInitials);

        function updatePhotoInitials() {
            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;

            if (firstName && lastName) {
                document.getElementById('photoInitials').textContent =
                    StringUtils.getInitials(firstName, lastName);
            }
        }

        // Form submission
        document.getElementById('registrationForm').addEventListener('submit', function (e) {
            e.preventDefault();

            // Validate form
            if (!validateForm()) {
                return;
            }

            // Collect form data
            const formData = {
                firstName: document.getElementById('firstName').value.trim(),
                lastName: document.getElementById('lastName').value.trim(),
                dateOfBirth: document.getElementById('dateOfBirth').value,
                gender: document.getElementById('gender').value,
                bloodGroup: document.getElementById('bloodGroup').value,
                phone: document.getElementById('phone').value.trim(),
                email: document.getElementById('email').value.trim() || null,
                address: {
                    street: document.getElementById('street').value.trim() || '',
                    city: document.getElementById('city').value.trim() || '',
                    county: document.getElementById('county').value.trim() || '',
                    country: 'Kenya'
                },
                allergies: document.getElementById('allergies').value.split(',').map(a => a.trim()).filter(a => a),
                chronicConditions: document.getElementById('chronicConditions').value.split(',').map(c => c.trim()).filter(c => c),
                emergencyContact: {
                    name: document.getElementById('emergencyName').value.trim(),
                    relationship: document.getElementById('emergencyRelationship').value,
                    phone: document.getElementById('emergencyPhone').value.trim()
                },
                photo: document.getElementById('photoImage').src || null,
                status: 'Active'
            };

            // Add insurance if provided
            const insuranceProvider = document.getElementById('insuranceProvider').value;
            if (insuranceProvider) {
                formData.insurance = {
                    provider: insuranceProvider,
                    policyNumber: document.getElementById('policyNumber').value.trim(),
                    expiryDate: document.getElementById('insuranceExpiry').value || null
                };
            } else {
                formData.insurance = null;
            }

            Loading.show(isEditMode ? 'Updating patient...' : 'Registering patient...');

            setTimeout(() => {
                if (isEditMode) {
                    // Update existing patient
                    const updated = storage.update('patients', patientId, formData);
                    Loading.hide();

                    if (updated) {
                        Toast.success('Patient updated successfully!');
                        setTimeout(() => {
                            window.location.href = `details.html?id=${patientId}`;
                        }, 1000);
                    } else {
                        Toast.error('Failed to update patient');
                    }
                } else {
                    // Create new patient
                    const upid = IDGenerator.generateUPID();
                    const now = new Date().toISOString();

                    const patient = {
                        id: upid,
                        ...formData,
                        registrationDate: now,
                        lastVisit: now,
                        createdBy: currentUser.id,
                        createdAt: now,
                        updatedAt: now
                    };

                    const created = storage.add('patients', patient);
                    Loading.hide();

                    if (created) {
                        Toast.success(`Patient registered successfully! UPID: ${upid}`);
                        setTimeout(() => {
                            window.location.href = `details.html?id=${upid}`;
                        }, 1500);
                    } else {
                        Toast.error('Failed to register patient');
                    }
                }
            }, 1000);
        });

        // Form validation
        function validateForm() {
            const phone = document.getElementById('phone').value;
            const email = document.getElementById('email').value;
            const emergencyPhone = document.getElementById('emergencyPhone').value;

            // Validate phone numbers
            if (!Validators.isPhone(phone)) {
                Toast.error('Invalid phone number format');
                document.getElementById('phone').focus();
                return false;
            }

            if (!Validators.isPhone(emergencyPhone)) {
                Toast.error('Invalid emergency contact phone number');
                document.getElementById('emergencyPhone').focus();
                return false;
            }

            // Validate email if provided
            if (email && !Validators.isEmail(email)) {
                Toast.error('Invalid email address');
                document.getElementById('email').focus();
                return false;
            }

            // Validate date of birth (not in future)
            const dob = new Date(document.getElementById('dateOfBirth').value);
            if (dob > new Date()) {
                Toast.error('Date of birth cannot be in the future');
                document.getElementById('dateOfBirth').focus();
                return false;
            }

            return true;
        }
    </script>
</body>

</html>