<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HMS - Drug Inventory</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Outfit:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">

    <!-- Stylesheets -->
    <link rel="stylesheet" href="../assets/css/reset.css">
    <link rel="stylesheet" href="../assets/css/variables.css">
    <link rel="stylesheet" href="../assets/css/typography.css">
    <link rel="stylesheet" href="../assets/css/components.css">
    <link rel="stylesheet" href="../assets/css/utilities.css">
    <link rel="stylesheet" href="../assets/css/animations.css">
    <link rel="stylesheet" href="../assets/css/responsive.css">
    <link rel="stylesheet" href="../assets/css/icons.css">

    <style>
        /* Common styles */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: var(--sidebar-width);
            background: white;
            border-right: 1px solid var(--gray-200);
            display: flex;
            flex-direction: column;
            z-index: 100;
        }

        .sidebar-header {
            padding: var(--space-6);
            border-bottom: 1px solid var(--gray-200);
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .sidebar-logo-icon {
            width: 40px;
            height: 40px;
            background: var(--gradient-primary);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: var(--text-xl);
        }

        .sidebar-logo-text {
            font-size: var(--text-lg);
            font-weight: var(--font-bold);
            color: var(--gray-900);
        }

        .sidebar-nav {
            flex: 1;
            padding: var(--space-4);
            overflow-y: auto;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius-md);
            color: var(--gray-700);
            font-weight: var(--font-medium);
            transition: all var(--transition-fast);
            cursor: pointer;
            margin-bottom: var(--space-1);
        }

        .nav-item:hover {
            background: var(--gray-50);
            color: var(--primary-500);
        }

        .nav-item.active {
            background: var(--gradient-primary);
            color: white;
        }

        .nav-icon {
            font-size: var(--text-xl);
            width: 24px;
            text-align: center;
        }

        .sidebar-footer {
            padding: var(--space-4);
            border-top: 1px solid var(--gray-200);
        }

        .header {
            position: fixed;
            top: 0;
            left: var(--sidebar-width);
            right: 0;
            height: var(--header-height);
            background: white;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--space-6);
            z-index: 90;
        }

        .header-search {
            flex: 1;
            max-width: 400px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: var(--font-semibold);
            font-size: var(--text-sm);
        }

        .main-content {
            margin-left: var(--sidebar-width);
            padding-top: var(--header-height);
            min-height: 100vh;
            background: var(--gray-50);
        }

        .content-area {
            padding: var(--space-6);
        }

        /* Inventory specific */
        .inventory-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-4);
            margin-bottom: var(--space-6);
        }

        .stat-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            box-shadow: var(--shadow-sm);
        }

        .stat-label {
            font-size: var(--text-sm);
            color: var(--gray-500);
            margin-bottom: var(--space-2);
        }

        .stat-value {
            font-size: var(--text-3xl);
            font-weight: var(--font-bold);
            color: var(--gray-900);
        }

        .filters {
            display: flex;
            gap: var(--space-3);
            margin-bottom: var(--space-6);
            flex-wrap: wrap;
        }

        .drug-grid {
            display: grid;
            gap: var(--space-4);
        }

        .drug-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-fast);
        }

        .drug-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .drug-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: var(--space-4);
        }

        .drug-name {
            font-size: var(--text-xl);
            font-weight: var(--font-semibold);
            color: var(--gray-900);
            margin-bottom: var(--space-1);
        }

        .drug-category {
            font-size: var(--text-sm);
            color: var(--gray-500);
        }

        .drug-stock {
            text-align: right;
        }

        .stock-quantity {
            font-size: var(--text-2xl);
            font-weight: var(--font-bold);
            color: var(--gray-900);
        }

        .stock-label {
            font-size: var(--text-xs);
            color: var(--gray-500);
            text-transform: uppercase;
        }

        .drug-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--space-4);
            margin-bottom: var(--space-4);
            padding-top: var(--space-4);
            border-top: 1px solid var(--gray-200);
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
        }

        .detail-label {
            font-size: var(--text-xs);
            color: var(--gray-500);
            text-transform: uppercase;
        }

        .detail-value {
            font-size: var(--text-sm);
            font-weight: var(--font-medium);
            color: var(--gray-900);
        }

        .batches-section {
            margin-top: var(--space-4);
            padding-top: var(--space-4);
            border-top: 1px solid var(--gray-200);
        }

        .batches-title {
            font-size: var(--text-sm);
            font-weight: var(--font-semibold);
            color: var(--gray-700);
            margin-bottom: var(--space-3);
        }

        .batch-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .batch-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-2) var(--space-3);
            background: var(--gray-50);
            border-radius: var(--radius-md);
            font-size: var(--text-sm);
        }

        .batch-number {
            font-weight: var(--font-medium);
            color: var(--gray-900);
        }

        .batch-expiry {
            color: var(--gray-600);
        }

        .batch-qty {
            font-weight: var(--font-semibold);
            color: var(--primary-500);
        }

        .drug-actions {
            display: flex;
            gap: var(--space-2);
            margin-top: var(--space-4);
        }

        @media (max-width: 1023px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .header {
                left: 0;
            }

            .main-content {
                margin-left: 0;
            }

            .header-search {
                display: none;
            }
        }
    </style>
</head>

<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <div class="logo-icon"></div>
                <div class="sidebar-logo-text">HMS</div>
            </div>
        </div>

        <nav class="sidebar-nav">
            <a href="../dashboard.html" class="nav-item">
                <span class="nav-icon">📊</span>
                <span>Dashboard</span>
            </a>
            <a href="../patients/list.html" class="nav-item">
                <span class="nav-icon">👥</span>
                <span>Patients</span>
            </a>
            <a href="../patients/queue.html" class="nav-item">
                <span class="nav-icon">⏱️</span>
                <span>Queue</span>
            </a>
            <a href="inventory.html" class="nav-item active">
                <span class="nav-icon">💊</span>
                <span>Pharmacy</span>
            </a>
            <a href="../laboratory/requests.html" class="nav-item">
                <span class="nav-icon">🔬</span>
                <span>Laboratory</span>
            </a>
            <a href="../billing/invoices.html" class="nav-item">
                <span class="nav-icon">💰</span>
                <span>Billing</span>
            </a>
            <a href="../reports/analytics.html" class="nav-item">
                <span class="nav-icon">📈</span>
                <span>Reports</span>
            </a>
        </nav>

        <div class="sidebar-footer">
            <button class="btn btn-ghost w-full" onclick="Auth.logout()">
                <span>🚪</span>
                <span>Logout</span>
            </button>
        </div>
    </aside>

    <!-- Header -->
    <header class="header">
        <div class="header-search">
            <button class="mobile-menu-toggle">
                <span>☰</span>
            </button>
            <input type="search" id="searchInput" class="form-input" placeholder="Search drugs...">
        </div>
        <div class="header-actions">
            <div class="user-avatar" id="userAvatar"></div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="content-area">
            <!-- Page Header -->
            <div class="page-header">
                <div>
                    <h1 class="page-title">Drug Inventory</h1>
                    <div class="breadcrumb">
                        <a href="../dashboard.html">Dashboard</a>
                        <span class="breadcrumb-separator">›</span>
                        <span class="breadcrumb-current">Pharmacy</span>
                    </div>
                </div>
                <div>
                    <a href="prescriptions.html" class="btn btn-secondary">
                        <span>📋</span>
                        <span>Prescriptions</span>
                    </a>
                </div>
            </div>

            <!-- Statistics -->
            <div class="inventory-stats">
                <div class="stat-card">
                    <div class="stat-label">Total Drugs</div>
                    <div class="stat-value" id="totalDrugs">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Stock</div>
                    <div class="stat-value" id="totalStock">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Low Stock Items</div>
                    <div class="stat-value" id="lowStock" style="color: var(--warning);">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Expiring Soon</div>
                    <div class="stat-value" id="expiringSoon" style="color: var(--danger);">0</div>
                </div>
            </div>

            <!-- Filters -->
            <div class="filters">
                <button class="btn btn-sm active" data-filter="all">All Drugs</button>
                <button class="btn btn-sm" data-filter="Antibiotics">Antibiotics</button>
                <button class="btn btn-sm" data-filter="Painkillers">Painkillers</button>
                <button class="btn btn-sm" data-filter="Antihistamines">Antihistamines</button>
                <button class="btn btn-sm" data-filter="low-stock">Low Stock</button>
                <button class="btn btn-sm" data-filter="expiring">Expiring Soon</button>
            </div>

            <!-- Drug Grid -->
            <div class="drug-grid" id="drugGrid">
                <!-- Drugs will be loaded here -->
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="empty-state" style="display: none;">
                <div class="empty-state-icon">💊</div>
                <div class="empty-state-title">No drugs found</div>
                <div class="empty-state-message">Try adjusting your search or filters</div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <!-- Scripts -->
    <script src="../assets/js/utils/icons.js"></script>
    <script src="../assets/js/utils/icon-init.js"></script>
    <script src="../assets/js/core/storage.js"></script>
    <script src="../assets/js/utils/helpers.js"></script>
    <script src="../assets/js/data/generator.js"></script>
    <script src="../assets/js/modules/auth.js"></script>
    <script src="../assets/js/components/ui.js"></script>

    <script>
        // Require authentication
        Auth.requireAuth();

        // Get current user
        const currentUser = Auth.getCurrentUser();
        document.getElementById('userAvatar').textContent = Auth.getUserInitials();

        // State
        let currentFilter = 'all';
        let searchQuery = '';

        // Load inventory
        function loadInventory() {
            let drugs = storage.getAll('drugs');
            const batches = storage.getAll('drug_batches');

            // Apply search
            if (searchQuery) {
                drugs = drugs.filter(drug =>
                    drug.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
                    drug.genericName?.toLowerCase().includes(searchQuery.toLowerCase())
                );
            }

            // Apply filter
            if (currentFilter !== 'all') {
                if (currentFilter === 'low-stock') {
                    drugs = drugs.filter(drug => {
                        const drugBatches = batches.filter(b => b.drugId === drug.id);
                        const totalStock = drugBatches.reduce((sum, b) => sum + b.quantity, 0);
                        return totalStock < drug.reorderLevel;
                    });
                } else if (currentFilter === 'expiring') {
                    const threeMonthsFromNow = new Date();
                    threeMonthsFromNow.setMonth(threeMonthsFromNow.getMonth() + 3);

                    const expiringDrugIds = batches
                        .filter(b => new Date(b.expiryDate) < threeMonthsFromNow && b.quantity > 0)
                        .map(b => b.drugId);

                    drugs = drugs.filter(drug => expiringDrugIds.includes(drug.id));
                } else {
                    drugs = drugs.filter(drug => drug.category === currentFilter);
                }
            }

            updateStatistics(batches);
            renderDrugs(drugs, batches);
        }

        // Update statistics
        function updateStatistics(batches) {
            const drugs = storage.getAll('drugs');
            const totalStock = batches.reduce((sum, b) => sum + b.quantity, 0);

            // Low stock count
            const lowStockCount = drugs.filter(drug => {
                const drugBatches = batches.filter(b => b.drugId === drug.id);
                const stock = drugBatches.reduce((sum, b) => sum + b.quantity, 0);
                return stock < drug.reorderLevel;
            }).length;

            // Expiring soon count (within 3 months)
            const threeMonthsFromNow = new Date();
            threeMonthsFromNow.setMonth(threeMonthsFromNow.getMonth() + 3);
            const expiringCount = batches.filter(b =>
                new Date(b.expiryDate) < threeMonthsFromNow && b.quantity > 0
            ).length;

            document.getElementById('totalDrugs').textContent = drugs.length;
            document.getElementById('totalStock').textContent = NumberUtils.formatNumber(totalStock);
            document.getElementById('lowStock').textContent = lowStockCount;
            document.getElementById('expiringSoon').textContent = expiringCount;
        }

        // Render drugs
        function renderDrugs(drugs, batches) {
            const drugGrid = document.getElementById('drugGrid');
            const emptyState = document.getElementById('emptyState');

            if (drugs.length === 0) {
                drugGrid.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            drugGrid.style.display = 'grid';
            emptyState.style.display = 'none';

            const html = drugs.map(drug => {
                const drugBatches = batches.filter(b => b.drugId === drug.id && b.quantity > 0);
                const totalStock = drugBatches.reduce((sum, b) => sum + b.quantity, 0);
                const isLowStock = totalStock < drug.reorderLevel;

                // Check for expiring batches
                const threeMonthsFromNow = new Date();
                threeMonthsFromNow.setMonth(threeMonthsFromNow.getMonth() + 3);
                const hasExpiringBatch = drugBatches.some(b => new Date(b.expiryDate) < threeMonthsFromNow);

                return `
          <div class="drug-card">
            <div class="drug-header">
              <div>
                <div class="drug-name">${drug.name}</div>
                <div class="drug-category">${drug.category} • ${drug.form}</div>
              </div>
              <div class="drug-stock">
                <div class="stock-quantity ${isLowStock ? 'text-warning' : ''}">${totalStock}</div>
                <div class="stock-label">In Stock</div>
              </div>
            </div>

            <div class="drug-details">
              <div class="detail-item">
                <div class="detail-label">Generic Name</div>
                <div class="detail-value">${drug.genericName || 'N/A'}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Strength</div>
                <div class="detail-value">${drug.strength}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Unit Price</div>
                <div class="detail-value">${NumberUtils.formatCurrency(drug.unitPrice)}</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Reorder Level</div>
                <div class="detail-value">${drug.reorderLevel}</div>
              </div>
            </div>

            ${drugBatches.length > 0 ? `
              <div class="batches-section">
                <div class="batches-title">
                  Available Batches (${drugBatches.length})
                  ${hasExpiringBatch ? '<span class="badge badge-danger badge-sm">Expiring Soon</span>' : ''}
                </div>
                <div class="batch-list">
                  ${drugBatches.slice(0, 3).map(batch => {
                    const daysToExpiry = DateUtils.getDaysUntilExpiry(batch.expiryDate);
                    const isExpiring = daysToExpiry < 90;

                    return `
                      <div class="batch-item">
                        <span class="batch-number">${batch.batchNumber}</span>
                        <span class="batch-expiry ${isExpiring ? 'text-danger' : ''}">
                          Exp: ${DateUtils.formatDate(batch.expiryDate, 'short')}
                        </span>
                        <span class="batch-qty">${batch.quantity} units</span>
                      </div>
                    `;
                }).join('')}
                  ${drugBatches.length > 3 ? `<div style="text-align: center; color: var(--gray-500); font-size: var(--text-sm);">+${drugBatches.length - 3} more batches</div>` : ''}
                </div>
              </div>
            ` : ''}

            <div class="drug-actions">
              ${isLowStock ? '<span class="badge badge-warning">Low Stock</span>' : ''}
              ${hasExpiringBatch ? '<span class="badge badge-danger">Expiring Soon</span>' : ''}
            </div>
          </div>
        `;
            }).join('');

            drugGrid.innerHTML = html;
        }

        // Search functionality
        let searchTimeout;
        document.getElementById('searchInput').addEventListener('input', function (e) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                searchQuery = e.target.value.trim();
                loadInventory();
            }, 300);
        });

        // Filter functionality
        document.querySelectorAll('.filters button').forEach(btn => {
            btn.addEventListener('click', function () {
                document.querySelectorAll('.filters button').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentFilter = this.dataset.filter;
                loadInventory();
            });
        });

        // Initialize
        loadInventory();
    </script>
</body>

</html>